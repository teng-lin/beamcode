<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>BeamCode</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/libsodium-wrappers-sumo/dist/modules/libsodium-wrappers.js"></script>
  <style>
    :root {
      --bg: #0d1117; --surface: #161b22; --surface-2: #21262d;
      --border: #30363d; --text: #e6edf3; --text-muted: #8b949e;
      --accent: #58a6ff; --success: #3fb950; --danger: #f85149;
      --warning: #d29922; --user-bg: #1f6feb; --code-bg: #0d1117;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text); font-size: 14px;
      display: flex; flex-direction: column;
      padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
    }

    /* Header */
    #header {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; background: var(--surface); border-bottom: 1px solid var(--border);
      min-height: 44px; flex-shrink: 0;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
      transition: background 0.3s;
    }
    .dot.disconnected { background: var(--danger); }
    .dot.connecting { background: var(--warning); animation: pulse 1s infinite; }
    .dot.connected { background: var(--success); }
    @keyframes pulse { 50% { opacity: 0.4; } }
    #status-text { color: var(--text-muted); font-size: 12px; min-width: 80px; }
    #session-status {
      margin-left: auto; font-size: 11px; color: var(--text-muted);
      background: var(--surface-2); padding: 2px 8px; border-radius: 10px;
    }

    /* Messages */
    #messages {
      flex: 1; overflow-y: auto; padding: 12px; display: flex;
      flex-direction: column; gap: 8px; scroll-behavior: smooth;
    }
    .msg { max-width: 100%; word-wrap: break-word; }
    .msg-label {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      margin-bottom: 4px; display: flex; align-items: center; gap: 6px;
    }
    .model-tag {
      font-size: 10px; font-weight: 400; background: var(--surface-2);
      padding: 1px 6px; border-radius: 8px;
    }

    /* User messages */
    .msg-user {
      align-self: flex-end; background: var(--user-bg);
      padding: 8px 12px; border-radius: 12px 12px 2px 12px; max-width: 85%;
    }
    .msg-user .msg-label { color: rgba(255,255,255,0.7); }
    .msg-user .msg-body { white-space: pre-wrap; }

    /* Assistant messages */
    .msg-assistant {
      background: var(--surface); padding: 10px 14px;
      border-radius: 2px 12px 12px 12px; border: 1px solid var(--border);
    }
    .msg-assistant .msg-body { line-height: 1.5; }
    .msg-assistant .msg-body p { margin: 0.4em 0; }
    .msg-assistant .msg-body p:first-child { margin-top: 0; }
    .msg-assistant .msg-body p:last-child { margin-bottom: 0; }
    .msg-assistant .msg-body ul, .msg-assistant .msg-body ol { padding-left: 1.5em; margin: 0.4em 0; }
    .msg-assistant .msg-body pre {
      background: var(--code-bg); border: 1px solid var(--border);
      border-radius: 6px; padding: 10px; overflow-x: auto;
      font-size: 13px; margin: 0.5em 0;
    }
    .msg-assistant .msg-body code {
      font-family: "SF Mono", SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 13px;
    }
    .msg-assistant .msg-body :not(pre) > code {
      background: var(--surface-2); padding: 2px 5px; border-radius: 4px;
    }
    .msg-assistant .msg-body a { color: var(--accent); }

    /* Content blocks */
    .tool-use-block {
      margin: 6px 0; background: var(--surface-2); border-radius: 6px;
      border: 1px solid var(--border); overflow: hidden;
    }
    .tool-header {
      padding: 6px 10px; font-size: 12px; font-weight: 600;
      color: var(--accent); background: rgba(88,166,255,0.08);
      border-bottom: 1px solid var(--border); cursor: pointer;
      user-select: none;
    }
    .tool-input {
      padding: 8px 10px; font-size: 12px; overflow-x: auto;
      max-height: 200px; overflow-y: auto; color: var(--text-muted); display: none;
      font-family: "SF Mono", SFMono-Regular, Consolas, monospace;
    }
    .tool-use-block.expanded .tool-input { display: block; }
    .tool-result-block {
      margin: 4px 0 6px 12px; padding: 6px 10px;
      border-left: 2px solid var(--border); font-size: 13px;
    }
    .tool-result-block pre {
      white-space: pre-wrap; color: var(--text-muted); margin: 0;
      max-height: 300px; overflow-y: auto;
    }
    .tool-error { border-left-color: var(--danger); }
    .tool-error pre { color: var(--danger); }

    .thinking-block {
      margin: 6px 0; color: var(--text-muted); font-size: 12px;
    }
    .thinking-block summary { cursor: pointer; font-style: italic; }
    .thinking-block pre {
      white-space: pre-wrap; padding: 8px; margin-top: 4px;
      max-height: 200px; overflow-y: auto;
    }

    /* System / status messages */
    .msg-system {
      text-align: center; font-size: 12px; color: var(--text-muted);
      padding: 4px 0;
    }
    .msg-error { color: var(--danger); }
    .msg-success { color: var(--success); }
    .msg-warning { color: var(--warning); }

    /* Result */
    .msg-result {
      text-align: center; font-size: 12px; padding: 6px 12px;
      border-radius: 6px; background: var(--surface);
      border: 1px solid var(--border);
    }
    .result-error { border-color: var(--danger); color: var(--danger); }
    .result-success { border-color: var(--success); color: var(--success); }

    /* Permission cards */
    .permission-card {
      background: var(--surface); border: 1px solid var(--warning);
      border-radius: 8px; padding: 12px; margin: 4px 0;
    }
    .perm-header {
      font-size: 12px; font-weight: 600; color: var(--warning); margin-bottom: 6px;
    }
    .perm-tool { font-weight: 600; margin-bottom: 6px; }
    .perm-desc { font-weight: 400; color: var(--text-muted); }
    .perm-input {
      font-size: 12px; background: var(--surface-2); padding: 8px;
      border-radius: 4px; overflow-x: auto; max-height: 150px; overflow-y: auto;
      margin-bottom: 10px; color: var(--text-muted);
      font-family: "SF Mono", SFMono-Regular, Consolas, monospace;
    }
    .perm-actions { display: flex; gap: 8px; }
    .btn {
      flex: 1; padding: 8px; border: none; border-radius: 6px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: opacity 0.15s;
    }
    .btn:active { opacity: 0.7; }
    .btn-approve { background: var(--success); color: #fff; }
    .btn-deny { background: var(--danger); color: #fff; }

    /* Input area */
    #input-bar {
      display: flex; align-items: flex-end; gap: 8px;
      padding: 8px 12px; background: var(--surface);
      border-top: 1px solid var(--border); flex-shrink: 0;
    }
    #input {
      flex: 1; resize: none; border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 12px; background: var(--surface-2);
      color: var(--text); font-size: 14px; font-family: inherit;
      max-height: 120px; line-height: 1.4; outline: none;
    }
    #input:focus { border-color: var(--accent); }
    #input::placeholder { color: var(--text-muted); }
    .input-btn {
      width: 36px; height: 36px; border-radius: 8px; border: none;
      font-size: 18px; cursor: pointer; display: flex;
      align-items: center; justify-content: center;
      flex-shrink: 0; transition: opacity 0.15s;
    }
    .input-btn:active { opacity: 0.7; }
    #send-btn { background: var(--accent); color: #fff; }
    #interrupt-btn { background: var(--danger); color: #fff; display: none; }

    /* Empty state */
    #empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; flex: 1; color: var(--text-muted); gap: 8px;
    }
    #empty-state h2 { font-size: 18px; color: var(--text); font-weight: 600; }
    #empty-state p { font-size: 13px; }
  </style>
</head>
<body>
  <header id="header">
    <span id="status-dot" class="dot disconnected"></span>
    <span id="status-text">Disconnected</span>
    <span id="session-status"></span>
  </header>

  <main id="messages">
    <div id="empty-state">
      <h2>BeamCode</h2>
      <p>Connecting to session…</p>
    </div>
  </main>

  <footer id="input-bar">
    <textarea id="input" rows="1" placeholder="Send a message…"></textarea>
    <button type="button" id="send-btn" class="input-btn" title="Send">&#x2191;</button>
    <button type="button" id="interrupt-btn" class="input-btn" title="Interrupt">&#x25A0;</button>
  </footer>

  <script>
  'use strict';

  // ── Utilities ──────────────────────────────────────────────────────────────

  function sanitizeHtml(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    for (const s of div.querySelectorAll('script,iframe,object,embed')) s.remove();
    for (const el of div.querySelectorAll('*')) {
      for (const attr of [...el.attributes]) {
        if (attr.name.startsWith('on')) el.removeAttribute(attr.name);
        if ((attr.name === 'href' || attr.name === 'src') &&
            attr.value.trimStart().startsWith('javascript:')) {
          el.removeAttribute(attr.name);
        }
      }
    }
    return div.innerHTML;
  }

  function truncate(s, max) {
    return s.length > max ? `${s.slice(0, max)}…` : s;
  }

  // ── ConsumerClient ─────────────────────────────────────────────────────────

  class ConsumerClient {
    constructor(wsUrl) {
      this._wsUrl = wsUrl;
      this._ws = null;
      this._consumerId = this._getOrCreateId();
      this._lastSeenSeq = 0;
      this._reconnectAttempt = 0;
      this._reconnectTimer = null;
      this._msgCbs = [];
      this._statusCbs = [];
      this._status = 'disconnected';
    }

    connect() {
      if (this._ws) return;
      this._setStatus('connecting');
      const url = new URL(this._wsUrl);
      url.searchParams.set('consumer_id', this._consumerId);
      if (this._lastSeenSeq > 0)
        url.searchParams.set('last_seen_seq', String(this._lastSeenSeq));

      this._ws = new WebSocket(url.toString());
      this._ws.onopen = () => { this._reconnectAttempt = 0; this._setStatus('connected'); };
      this._ws.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.seq != null) this._lastSeenSeq = msg.seq;
          for (const cb of this._msgCbs) cb(msg);
        } catch {}
      };
      this._ws.onclose = () => { this._ws = null; this._setStatus('disconnected'); this._scheduleReconnect(); };
      this._ws.onerror = () => { if (this._ws) this._ws.close(); };
    }

    disconnect() {
      if (this._reconnectTimer) { clearTimeout(this._reconnectTimer); this._reconnectTimer = null; }
      this._reconnectAttempt = 0;
      if (this._ws) this._ws.close();
      this._ws = null;
      this._setStatus('disconnected');
    }

    send(message) {
      if (this._ws && this._ws.readyState === WebSocket.OPEN)
        this._ws.send(JSON.stringify(message));
    }

    onMessage(cb) { this._msgCbs.push(cb); }
    onStatusChange(cb) { this._statusCbs.push(cb); }

    _getOrCreateId() {
      const key = 'beamcode_consumer_id';
      let id = localStorage.getItem(key);
      if (!id) { id = crypto.randomUUID(); localStorage.setItem(key, id); }
      return id;
    }

    _setStatus(s) { this._status = s; for (const cb of this._statusCbs) cb(s); }

    _scheduleReconnect() {
      const delay = Math.min(1000 * 2 ** this._reconnectAttempt, 30000);
      this._reconnectAttempt++;
      this._reconnectTimer = setTimeout(() => { this._reconnectTimer = null; this.connect(); }, delay);
    }
  }

  // ── MessageRenderer ────────────────────────────────────────────────────────

  class MessageRenderer {
    render(message) {
      switch (message.type) {
        case 'assistant': return this.renderAssistant(message.message);
        case 'result': return this.renderResult(message.data);
        case 'status_change': return this._renderStatus(message.status);
        case 'error': return this._system(message.message, 'error');
        case 'cli_connected': return this._system('CLI connected', 'success');
        case 'cli_disconnected': return this._system('CLI disconnected', 'warning');
        case 'user_message': return this._renderUser(message.content);
        case 'slash_command_result': return this._system(message.content, 'info');
        case 'slash_command_error': return this._system(message.error, 'error');
        default: return null;
      }
    }

    renderAssistant(content) {
      const w = document.createElement('div');
      w.className = 'msg msg-assistant';
      const lbl = document.createElement('div');
      lbl.className = 'msg-label';
      lbl.textContent = 'Assistant';
      if (content.model) {
        const m = document.createElement('span');
        m.className = 'model-tag';
        m.textContent = content.model;
        lbl.appendChild(m);
      }
      w.appendChild(lbl);
      const body = document.createElement('div');
      body.className = 'msg-body';
      for (const block of content.content) body.appendChild(this._block(block));
      w.appendChild(body);
      return w;
    }

    renderResult(data) {
      const el = document.createElement('div');
      el.className = `msg msg-result ${data.is_error ? 'result-error' : 'result-success'}`;
      const dur = (data.duration_ms / 1000).toFixed(1);
      const cost = data.total_cost_usd.toFixed(4);
      const tokens = data.usage.input_tokens + data.usage.output_tokens;
      let t = `${data.is_error ? 'Error' : 'Done'} \u2014 ${dur}s \u00B7 $${cost} \u00B7 ${tokens} tokens`;
      if (data.total_lines_added || data.total_lines_removed)
        t += ` \u00B7 +${data.total_lines_added || 0}/-${data.total_lines_removed || 0}`;
      el.textContent = t;
      return el;
    }

    _block(block) {
      switch (block.type) {
        case 'text': {
          const el = document.createElement('div');
          el.className = 'content-block text-block';
          el.innerHTML = sanitizeHtml(marked.parse(block.text));
          return el;
        }
        case 'tool_use': {
          const el = document.createElement('div');
          el.className = 'content-block tool-use-block';
          const hdr = document.createElement('div');
          hdr.className = 'tool-header';
          hdr.textContent = `\u{1F527} ${block.name}`;
          hdr.addEventListener('click', () => el.classList.toggle('expanded'));
          el.appendChild(hdr);
          const pre = document.createElement('pre');
          pre.className = 'tool-input';
          pre.textContent = truncate(JSON.stringify(block.input, null, 2), 500);
          el.appendChild(pre);
          return el;
        }
        case 'tool_result': {
          const el = document.createElement('div');
          el.className = `content-block tool-result-block${block.is_error ? ' tool-error' : ''}`;
          if (typeof block.content === 'string') {
            const pre = document.createElement('pre');
            pre.textContent = truncate(block.content, 2000);
            el.appendChild(pre);
          } else if (Array.isArray(block.content)) {
            for (const b of block.content) el.appendChild(this._block(b));
          }
          return el;
        }
        case 'thinking': {
          const d = document.createElement('details');
          d.className = 'content-block thinking-block';
          const s = document.createElement('summary');
          s.textContent = 'Thinking\u2026';
          d.appendChild(s);
          const pre = document.createElement('pre');
          pre.textContent = block.thinking;
          d.appendChild(pre);
          return d;
        }
        default: return document.createElement('span');
      }
    }

    _renderUser(content) {
      const el = document.createElement('div');
      el.className = 'msg msg-user';
      const lbl = document.createElement('div');
      lbl.className = 'msg-label';
      lbl.textContent = 'You';
      el.appendChild(lbl);
      const body = document.createElement('div');
      body.className = 'msg-body';
      body.textContent = content;
      el.appendChild(body);
      return el;
    }

    _renderStatus(status) {
      if (!status || status === 'idle') return null;
      const el = document.createElement('div');
      el.className = 'msg msg-system';
      el.textContent = status;
      return el;
    }

    _system(text, level) {
      const el = document.createElement('div');
      el.className = `msg msg-system msg-${level}`;
      el.textContent = text;
      return el;
    }
  }

  // ── PermissionUI ───────────────────────────────────────────────────────────

  class PermissionUI {
    constructor(container) {
      this._container = container;
      this._cards = new Map();
    }

    showRequest(request, onRespond) {
      const card = document.createElement('div');
      card.className = 'permission-card';

      const hdr = document.createElement('div');
      hdr.className = 'perm-header';
      hdr.textContent = 'Permission Request';
      card.appendChild(hdr);

      const tool = document.createElement('div');
      tool.className = 'perm-tool';
      tool.textContent = request.tool_name;
      if (request.description) {
        const desc = document.createElement('span');
        desc.className = 'perm-desc';
        desc.textContent = ` \u2014 ${request.description}`;
        tool.appendChild(desc);
      }
      card.appendChild(tool);

      const pre = document.createElement('pre');
      pre.className = 'perm-input';
      const s = JSON.stringify(request.input, null, 2);
      pre.textContent = s.length > 500 ? `${s.slice(0, 500)}\u2026` : s;
      card.appendChild(pre);

      const actions = document.createElement('div');
      actions.className = 'perm-actions';

      const approve = document.createElement('button');
      approve.className = 'btn btn-approve';
      approve.textContent = 'Approve';
      approve.addEventListener('click', () => { onRespond(true); this.removeRequest(request.request_id); });

      const deny = document.createElement('button');
      deny.className = 'btn btn-deny';
      deny.textContent = 'Deny';
      deny.addEventListener('click', () => { onRespond(false); this.removeRequest(request.request_id); });

      actions.appendChild(approve);
      actions.appendChild(deny);
      card.appendChild(actions);

      this._cards.set(request.request_id, card);
      this._container.appendChild(card);
      return card;
    }

    removeRequest(id) {
      const card = this._cards.get(id);
      if (card) { card.remove(); this._cards.delete(id); }
    }
  }

  // ── CryptoClient (stub) ────────────────────────────────────────────────────

  class CryptoClient {
    constructor() { this._paired = false; }
    async initFromPairingLink(_params) { this._paired = false; }
    async encrypt(msg) { return msg; }
    async decrypt(ct) { return ct; }
    isPaired() { return this._paired; }
  }

  // ── App ────────────────────────────────────────────────────────────────────

  (() => {
    const messagesEl = document.getElementById('messages');
    const emptyState = document.getElementById('empty-state');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send-btn');
    const interruptBtn = document.getElementById('interrupt-btn');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const sessionStatus = document.getElementById('session-status');

    // Parse URL params (support both ?key=val and #key=val)
    const params = new URLSearchParams(location.search || location.hash.slice(1));
    const sessionId = params.get('session') || '';
    const wsParam = params.get('ws') || '';

    let wsUrl;
    if (wsParam) {
      wsUrl = `${wsParam.replace(/\/$/, '')}/ws/consumer/${sessionId}`;
    } else {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      wsUrl = `${proto}//${location.host}/ws/consumer/${sessionId}`;
    }

    if (!sessionId) {
      emptyState.querySelector('p').textContent = 'No session ID provided. Add ?session=<uuid> to the URL.';
      return;
    }

    const client = new ConsumerClient(wsUrl);
    const renderer = new MessageRenderer();
    const permissionUI = new PermissionUI(messagesEl);
    const crypto = new CryptoClient();

    let cliStatus = null;
    let autoScroll = true;

    // Auto-scroll logic
    messagesEl.addEventListener('scroll', () => {
      autoScroll = messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 60;
    });

    function scrollToBottom() {
      if (autoScroll) messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function appendElement(el) {
      if (!el) return;
      if (emptyState.parentNode) emptyState.remove();
      messagesEl.appendChild(el);
      scrollToBottom();
    }

    // Connection status
    client.onStatusChange((status) => {
      statusDot.className = `dot ${status}`;
      const labels = { connected: 'Connected', connecting: 'Connecting…', disconnected: 'Disconnected' };
      statusText.textContent = labels[status] || status;
    });

    // Message routing
    client.onMessage((msg) => {
      switch (msg.type) {
        case 'session_init':
          if (msg.session?.model) {
            document.title = `BeamCode — ${msg.session.cwd || ''}`;
          }
          break;

        case 'message_history':
          // Clear existing messages and replay
          while (messagesEl.firstChild) messagesEl.removeChild(messagesEl.firstChild);
          if (msg.messages) {
            for (const m of msg.messages) {
              const el = renderer.render(m);
              if (el) messagesEl.appendChild(el);
            }
          }
          scrollToBottom();
          break;

        case 'permission_request':
          permissionUI.showRequest(msg.request, (approved) => {
            client.send({
              type: 'permission_response',
              request_id: msg.request.request_id,
              behavior: approved ? 'allow' : 'deny',
            });
          });
          scrollToBottom();
          break;

        case 'permission_cancelled':
          permissionUI.removeRequest(msg.request_id);
          break;

        case 'status_change':
          cliStatus = msg.status;
          sessionStatus.textContent = msg.status || '';
          interruptBtn.style.display = msg.status === 'running' ? '' : 'none';
          // Don't render a message for idle transitions
          if (msg.status && msg.status !== 'idle') {
            appendElement(renderer.render(msg));
          }
          break;

        case 'tool_progress': {
          // Update existing tool-use header with elapsed time
          const blocks = messagesEl.querySelectorAll('.tool-use-block');
          for (const b of blocks) {
            const hdr = b.querySelector('.tool-header');
            if (hdr?.textContent.includes(msg.tool_name)) {
              const s = msg.elapsed_time_seconds.toFixed(0);
              hdr.textContent = `\u{1F527} ${msg.tool_name} (${s}s)`;
            }
          }
          break;
        }

        default:
          appendElement(renderer.render(msg));
          break;
      }
    });

    // Input handling
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = `${Math.min(inputEl.scrollHeight, 120)}px`;
    });

    function sendMessage() {
      const content = inputEl.value.trim();
      if (!content) return;
      client.send({ type: 'user_message', content: content, session_id: sessionId });
      // Show user message locally immediately
      appendElement(renderer._renderUser(content));
      inputEl.value = '';
      inputEl.style.height = 'auto';
    }

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    interruptBtn.addEventListener('click', () => {
      client.send({ type: 'interrupt' });
    });

    // Escape to interrupt
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && cliStatus === 'running') {
        client.send({ type: 'interrupt' });
      }
    });

    // Connect
    client.connect();
  })();
  </script>
</body>
</html>
